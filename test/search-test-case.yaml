id: create-patients
desc: Create Patients


steps:
# Prerequisites

- id: clean
  POST: /$sql
  body: "TRUNCATE Patient"
  match:
    status: 200

- id: create
  PUT: /
  body:
  - id: pt-1
    resourceType: Patient
    name: [{given: [Vlad], family: Ganshin}]
    birthDate: '1994-09-26'
    address: [{city: St. Petersburg}]
    text:
      status: additional
      div: Healthy Patient
  - id: pt-2
    resourceType: Patient
    name: [{given: [Anna]}]
    birthDate: '1994-08-07'
    address: [{city: Kolpino}]
    text:
      status: additional
      div: Unknown
  - id: pt-3
    resourceType: Patient
    name: [{given: [Ivan]}]
    address: [{city: Pushkin}]
    text:
      status: additional
      div: In progress
  match:
    status: 200

# https://docs.aidbox.app/basic-concepts/search-1/_id

- id: find-patient-by-id
  GET: /Patient?_id=pt-1
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
          name: [{given: [Vlad]}]
          birthDate: '1994-09-26'
          address: [{city: St. Petersburg}]

- id: find-patients-by-ids
  GET: "/Patient?_id=pt-1,pt-2,pt-3&_sort=id"
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
          name: [{given: [Vlad]}]
      - resource:
          id: pt-2
          name: [{given: [Anna]}]
      - resource:
          id: pt-3
          name: [{given: [Ivan]}]

# https://docs.aidbox.app/basic-concepts/search-1/_lastupdated

- id: prerequisites-for-lastupadated
  POST: /$sql
  body: |
    update patient
    set ts = '2001-01-01'
    where id in ('pt-1', 'pt-2');
  match:
    status: 200

- id: find-patients-updated-at-time
  GET: "/Patient?_lastUpdated=2001-01-01&_sort=id"
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
      - resource:
          id: pt-2

- id: find-patients-updated-at-time
  GET: "/Patient?_lastUpdated=lt2001-01-02&_sort=id"
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
      - resource:
          id: pt-2


# https://docs.aidbox.app/basic-concepts/search-1/_text-and-_content

- id: prerequisites-for-text-and-content
  POST: /$sql
  body: |
    update patient
    set ts = '2001-01-01'
    where id in ('pt-1', 'pt-2', 'pt-3');
  match:
    status: 200

- id: search-by-text 
  GET: "/Patient?_lastUpdated=2001-01-01&_sort=id&_text=healthy"
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1

- id: search-by-content
  GET: "/Patient?_lastUpdated=2001-01-01&_sort=id&_content=Vlad"
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
 

# https://docs.aidbox.app/basic-concepts/search-1/_ilike

# ...


# https://docs.aidbox.app/basic-concepts/search-1/_elements

- id: get-only-id-and-firstname-of-patient
  GET: /Patient?_id=pt-1,_elements=id,name.given
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
          resourceType: Patient # resourceType is always presented
          name: [{given: [Vlad]}]

- id: get-all-fields-of-patient-except-meta
  GET: /Patient?_id=pt-1,_elements=-meta,-resourceType # resourceType is always presented
  match:
    status: 200
    body:
      entry:
      - resource:
          id: pt-1
          resourceType: Patient
          name: [{given: [Vlad], family: Ganshin}]
          birthDate: '1994-09-26'
          address: [{city: St. Petersburg}]
          text:
            status: additional
            div: Healthy Patient

# https://docs.aidbox.app/basic-concepts/search-1/_summary

# ...

# https://docs.aidbox.app/basic-concepts/search-1/_list

# ...

# https://docs.aidbox.app/basic-concepts/search-1/_count-and-_page

- id: get-only-first-patient
  GET: /Patient?_count=1&_page=2
  match:
    status: 200
    body:
      entry:
        - resource:
            id: pt-2
            resourceType: Patient
            name: [given: [Anna]]
            birthDate: '1994-08-07'
            address: [{city: Kolpino}]
            text:
              status: additional
              div: Unknown

# https://docs.aidbox.app/basic-concepts/search-1/_total-or-_countmethod

- id: get-patients-list-without-running-count-query
  GET: /Patient?_total=none&_count=1&_elements=id,name.given
  match:
    status: 200
    body:
      entry:
        - resource:
            id: pt-1
            resourceType: Patient
            name: [{given: [Vlad]}]

# https://docs.aidbox.app/basic-concepts/search-1/_sort

- id: get-patients-sorted-in-reverse-order-by-id
  GET: /Patient?_sort=-id&_elements=id
  match:
    status: 200
    body:
      entry:
        - resource:
            id: pt-3
            resourceType: Patient
        - resource:
            id: pt-2
            resourceType: Patient
        - resource:
            id: pt-1
            resourceType: Patient

