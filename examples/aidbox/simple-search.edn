{ns aidbox.simple-search
 import #{sty sty.fhir sty.aidbox}

 case
 {:zen/tags #{sty/case}
  :title "Test case"
  :steps
  {:clean
   {:desc "Clear all patients"
    :action {:type sty.aidbox/sql :sql "TRUNCATE patient"}}

   :pts
   {:desc  "Create number of patients"
    :action {:type sty.aidbox/load
             :resources [{:resourceType "Patient" :id "pt-1"}]}}

   :find
   {:action  {:type sty/http :method :get :url "/Patient/pt-1"}
    :matches {:type sty/matcho :status 200 :body {:id sty/string?}}}


   :search
   {:action  {:type sty/http :method :get :url "/Patient?name=ups"}
    :matches {:type sty/matcho :status 200 :body {:entry [{:resource {:id "pt-1"}}]}}}

   :search-with-params
   {:action {:type sty/http 
             :method :get
             :url "/Patient?name=ups"
             :params {:name "ups"}}
    :matches {:type sty/matcho :status 200 :body {:entry [{:resource {:id "pt-1"}}]}}}


   :search-with-fhir
   {:action {:type fhir/search
             :resourceType "Patient"
             :params {:name "ups"}}}

   :debug-expr
   {:action {:type sty/print :expression (get-in sty/case [:search-with-fhir])}}

   :debug-path
   {:action {:type sty/print :path [:search-with-fhir]}}


   }}}
